# 性能優化報告模板

> 此模板可用於期末報告的性能優化章節

---

## 一、優化目標

本專案實施性能優化的目標：

1. **降低系統回應時間**：目標降低 30% 以上
2. **提升系統吞吐量**：目標提升 50% 以上
3. **改善系統穩定性**：P95 回應時間降低 30% 以上
4. **優化資源使用**：降低 CPU 和記憶體使用率

---

## 二、優化措施

### 2.1 快取機制 (Caching)

**實作位置：** `services/cacheService.js`

**技術細節：**
- 使用記憶體快取（Map 資料結構）
- 實現 TTL (Time To Live) 自動過期機制
- 快取鍵生成策略：`prefix:param1:value1|param2:value2`
- 定期清理過期項目（每 5 分鐘）

**快取策略：**
- 感測器數據查詢：2 秒 TTL（即時更新）
- 報表摘要：2 秒 TTL
- 優先級統計：5 秒 TTL

**預期效果：**
- 減少資料庫讀取次數 70% 以上
- 熱點數據查詢速度提升 80% 以上

### 2.2 非同步處理 (Async Processing)

**實作位置：** `services/asyncProcessor.js`

**技術細節：**
- 使用 `setImmediate` 實現非阻塞處理
- 優先級計算改為非同步執行
- 批量數據處理使用並行策略
- 任務佇列管理

**優化點：**
- 優先級計算不阻塞主線程
- 上傳調度器使用 `setImmediate` 延遲執行
- 批量數據處理並行化

**預期效果：**
- 提升吞吐量 50% 以上
- 避免長時間計算阻塞請求

### 2.3 演算法優化

**實作位置：** `services/priorityEngine.js`

**優化內容：**
- 減少函數調用開銷
- 直接計算而非多次調用
- 使用查表法加速網路狀態查詢
- 單次遍歷計算統計（而非多次遍歷）

**優化前後對比：**

```javascript
// 優化前：多次函數調用
const importanceScore = normalizeImportance(dataImportance);
const batteryScore = calculateBatteryScore(battery);

// 優化後：直接計算
const importanceScore = Math.max(0, Math.min(10, dataImportance));
const batteryScore = 10 * Math.pow(1 - normalizedBattery / 100, 0.7);
```

**預期效果：**
- 降低 CPU 使用率 20% 以上
- 減少記憶體分配
- 提升計算速度 30% 以上

### 2.4 效能監控

**實作位置：** `middleware/performanceMonitor.js`

**功能：**
- 自動記錄所有 API 請求回應時間
- 計算統計指標（平均、P50、P95、P99）
- 提供效能統計 API
- 支援重置統計

---

## 三、測試方法

### 3.1 測試環境

- **作業系統**：Windows 10 / Linux
- **Node.js 版本**：v18.x 或以上
- **測試工具**：自訂性能測試腳本
- **測試數據**：使用模擬器生成 100+ 筆感測器數據

### 3.2 測試配置

- **並發請求數**：10
- **總請求數**：100（每個端點）
- **測試端點**：
  - `/api/sensors/data?limit=20`
  - `/api/reports/summary`
  - `/api/sensors/priority/stats`

### 3.3 測試流程

1. **階段 1：優化前測試**
   - 清除所有快取
   - 執行 100 個並發請求
   - 記錄性能指標

2. **階段 2：優化後測試**
   - 使用快取機制
   - 執行相同數量的請求
   - 記錄性能指標

3. **生成對比報告**
   - 計算改善百分比
   - 生成詳細報告

### 3.4 執行測試

```bash
# 1. 啟動後端服務器
npm start

# 2. 生成測試數據（可選）
python tests/simulator_backend.py --sensors 5 --messages 20

# 3. 執行性能對比測試
npm run test:comparison
```

---

## 四、測試結果

### 4.1 總體性能對比

| 指標 | 優化前 | 優化後 | 改善幅度 |
|------|--------|--------|----------|
| **平均回應時間** | [填入數據] ms | [填入數據] ms | **[填入百分比]%** ⬇️ |
| **P95 回應時間** | [填入數據] ms | [填入數據] ms | **[填入百分比]%** ⬇️ |
| **P99 回應時間** | [填入數據] ms | [填入數據] ms | **[填入百分比]%** ⬇️ |
| **吞吐量** | [填入數據] 請求/秒 | [填入數據] 請求/秒 | **[填入百分比]%** ⬆️ |

### 4.2 各端點詳細對比

#### 4.2.1 `/api/sensors/data?limit=20`

| 指標 | 優化前 | 優化後 | 改善 |
|------|--------|--------|------|
| 平均回應時間 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| P95 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| 吞吐量 | [填入數據] 請求/秒 | [填入數據] 請求/秒 | [填入百分比]% ⬆️ |

#### 4.2.2 `/api/reports/summary`

| 指標 | 優化前 | 優化後 | 改善 |
|------|--------|--------|------|
| 平均回應時間 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| P95 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| 吞吐量 | [填入數據] 請求/秒 | [填入數據] 請求/秒 | [填入百分比]% ⬆️ |

#### 4.2.3 `/api/sensors/priority/stats`

| 指標 | 優化前 | 優化後 | 改善 |
|------|--------|--------|------|
| 平均回應時間 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| P95 | [填入數據] ms | [填入數據] ms | [填入百分比]% ⬇️ |
| 吞吐量 | [填入數據] 請求/秒 | [填入數據] 請求/秒 | [填入百分比]% ⬆️ |

### 4.3 快取統計

- **快取命中率**：[填入數據]%
- **快取大小**：[填入數據] 項目
- **快取清理次數**：[填入數據]

---

## 五、結果分析

### 5.1 改善原因分析

1. **快取機制效果**
   - 快取命中率達到 [填入數據]%，有效減少資料庫讀取
   - 熱點數據查詢速度提升 [填入數據]%

2. **非同步處理效果**
   - 吞吐量提升 [填入數據]%
   - 系統並發處理能力增強

3. **演算法優化效果**
   - CPU 使用率降低 [填入數據]%
   - 計算速度提升 [填入數據]%

### 5.2 優化效果評估

根據測試結果，系統性能得到顯著提升：

✅ **回應時間降低 [填入百分比]%**  
✅ **吞吐量提升 [填入百分比]%**  
✅ **系統穩定性提升**（P95/P99 指標改善）  
✅ **資源使用優化**（CPU/記憶體使用率降低）  

### 5.3 達成目標情況

| 目標 | 預期 | 實際 | 達成情況 |
|------|------|------|----------|
| 回應時間降低 | ≥30% | [填入數據]% | ✅/❌ |
| 吞吐量提升 | ≥50% | [填入數據]% | ✅/❌ |
| P95 回應時間降低 | ≥30% | [填入數據]% | ✅/❌ |

---

## 六、結論

通過實施快取機制、非同步處理和演算法優化，系統性能得到顯著提升：

1. **回應時間大幅降低**：平均回應時間降低 [填入百分比]%，P95 回應時間降低 [填入百分比]%
2. **吞吐量顯著提升**：從 [填入數據] 請求/秒提升至 [填入數據] 請求/秒，提升 [填入百分比]%
3. **系統穩定性改善**：P99 回應時間降低 [填入百分比]%，系統在極端情況下表現更穩定
4. **資源使用優化**：CPU 和記憶體使用率降低，系統負載更均衡

這些優化措施有效提升了系統的整體性能和用戶體驗，達成了預期的優化目標。

---

## 七、未來改進方向

1. **資料庫優化**
   - 使用索引加速查詢
   - 連接池管理
   - 查詢優化

2. **分散式快取**
   - 使用 Redis 實現分散式快取
   - 更長的 TTL
   - 快取預熱

3. **負載均衡**
   - 實現負載均衡器
   - 地理分佈
   - CDN 加速

4. **資料壓縮**
   - Gzip 壓縮
   - 回應資料壓縮
   - 減少傳輸量

---

## 附錄

### A. 測試報告

詳細測試報告請參見：`reports/performance-comparison-report.md`

### B. 測試數據

原始測試數據（JSON 格式）：`reports/performance-comparison-report.json`

### C. 性能統計 API

訪問 `http://localhost:3000/api/performance/stats` 可查看實時性能統計。

---

*報告生成時間：[填入日期]*


